<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº”å­æ£‹ç«¶æŠ€å°æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            touch-action: none;
        }

        .board-bg {
            background-color: #eecfa1;
            background-image: linear-gradient(45deg, #e6c694 25%, transparent 25%, transparent 75%, #e6c694 75%, #e6c694),
            linear-gradient(45deg, #e6c694 25%, transparent 25%, transparent 75%, #e6c694 75%, #e6c694);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }

        .modal { transition: opacity 0.3s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; }

        /* ç©å®¶é¢æ¿ç‹€æ…‹æ¨£å¼ */
        .player-panel {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.4;
            transform: scale(0.95);
            filter: grayscale(0.8);
        }
        
        .player-panel.active {
            opacity: 1;
            transform: scale(1.05);
            filter: grayscale(0);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            border-color: #3b82f6;
        }

        /* æ£‹å­æ¨£å¼ (ç”¨æ–¼é¢æ¿å±•ç¤º) */
        .stone-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.4);
            margin-bottom: 8px;
        }
        .stone-icon-black {
            background: radial-gradient(circle at 30% 30%, #666, #000);
        }
        .stone-icon-white {
            background: radial-gradient(circle at 30% 30%, #fff, #ddd);
            border: 1px solid #ccc;
        }

        /* å‘¼å¸ç‡ˆå‹•ç•« */
        @keyframes pulse-light {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .player-panel.active .turn-badge {
            animation: pulse-light 2s infinite;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col overflow-hidden relative">

    <!-- é ‚éƒ¨è³‡è¨Šåˆ— -->
    <div class="w-full h-16 bg-white shadow-md z-10 flex items-center justify-between px-4 relative shrink-0">
        <div class="w-24"></div>
        <h1 class="text-xl md:text-2xl font-bold text-gray-800 absolute left-1/2 transform -translate-x-1/2 whitespace-nowrap">
            äº”å­æ£‹ç«¶æŠ€
        </h1>
        <div class="flex items-center gap-2 z-20">
            <button onclick="openRules()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded shadow text-sm transition flex items-center gap-1">
                <i class="fas fa-book"></i> <span class="hidden sm:inline">è¦å‰‡</span>
            </button>
            <button onclick="resetGamePrompt()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded shadow text-sm transition flex items-center gap-1">
                <i class="fas fa-redo"></i> <span class="hidden sm:inline">è¨­ å®š</span>
            </button>
        </div>
    </div>

    <!-- æ–°å¢ï¼šæç¤ºè¨Šæ¯æ©«å¹… -->
    <div id="hint-notification" class="w-full p-2 text-center text-sm font-bold hidden z-20 relative shrink-0 transition-all duration-300">
        <!-- å…§å®¹ç”± JS å‹•æ…‹å¡«å…… -->
    </div>

    <!-- éŠæˆ²ä¸»å€åŸŸ -->
    <div class="flex-grow flex flex-col md:flex-row items-center justify-center p-2 md:p-4 gap-4 md:gap-8 w-full h-full overflow-hidden relative" style="max-height: calc(100vh - 64px);">
        
        <!-- å·¦å´ï¼šé»‘æ–¹é¢æ¿ -->
        <div id="panel-black" class="player-panel flex flex-row md:flex-col items-center justify-center bg-white p-3 md:p-6 rounded-xl border-2 border-gray-200 shadow-lg w-full md:w-32 lg:w-40 shrink-0">
            <div class="stone-icon stone-icon-black mr-3 md:mr-0"></div>
            <div class="text-center">
                <h3 class="text-lg font-bold text-gray-800">é»‘æ£‹</h3>
                <span class="text-xs text-gray-500">(å…ˆæ‰‹)</span>
                <div class="turn-badge mt-2 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-bold hidden md:block opacity-0 transition-opacity">
                    æ€è€ƒä¸­...
                </div>
            </div>
            <div id="timer-black" class="timer-box ml-auto md:ml-0 md:mt-4 font-mono text-xl font-bold text-gray-600">--</div>
        </div>

        <!-- ä¸­å¤®ï¼šæ£‹ç›¤ -->
        <div class="relative board-bg rounded p-1 sm:p-2 shadow-2xl shrink-0" style="max-height: 80vh; aspect-ratio: 1/1;">
            <canvas id="gameCanvas" width="600" height="600" class="cursor-pointer bg-[#dcb35c] rounded w-full h-full"></canvas>
        </div>

        <!-- å³å´ï¼šç™½æ–¹é¢æ¿ -->
        <div id="panel-white" class="player-panel flex flex-row md:flex-col items-center justify-center bg-white p-3 md:p-6 rounded-xl border-2 border-gray-200 shadow-lg w-full md:w-32 lg:w-40 shrink-0">
            <div class="stone-icon stone-icon-white mr-3 md:mr-0"></div>
            <div class="text-center">
                <h3 class="text-lg font-bold text-gray-800">ç™½æ£‹</h3>
                <span class="text-xs text-gray-500">(å¾Œæ‰‹)</span>
                <div class="turn-badge mt-2 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-bold hidden md:block opacity-0 transition-opacity">
                    æ€è€ƒä¸­...
                </div>
            </div>
            <div id="timer-white" class="timer-box ml-auto md:ml-0 md:mt-4 font-mono text-xl font-bold text-gray-600">--</div>
        </div>

    </div>

    <!-- åˆå§‹è¨­å®šæµ®çª— (Settings Modal) -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 modal backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-2xl p-0 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-gray-800 text-white p-4 text-center">
                <h2 class="text-2xl font-bold">äº”å­æ£‹å°æˆ°è¨­å®š</h2>
            </div>
            
            <div class="p-6 overflow-y-auto">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- å·¦å´ï¼šè¨­å®š -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2"><i class="fas fa-cog"></i> å°å±€è¨­å®š</h3>
                        
                        <!-- è¨ˆæ™‚è¨­å®š -->
                        <div class="mb-5">
                            <label class="block text-gray-700 font-bold mb-2 text-sm">â±ï¸ æ™‚é–“è¦å‰‡</label>
                            <select id="timer-mode" class="w-full p-2 border border-gray-300 rounded mb-2 bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="none">ä¸è¨ˆæ™‚ (è¼•é¬†æ¨¡å¼)</option>
                                <option value="step">æ­¥æ™‚é™åˆ¶ (æ¯æ‰‹é™æ™‚)</option>
                                <option value="bank">å±€æ™‚å€’æ‰£ (ç¸½æ™‚é–“é™åˆ¶)</option>
                            </select>
                            
                            <div id="timer-options" class="hidden">
                                <select id="timer-seconds" class="w-full p-2 border border-gray-300 rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
                                    <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                                </select>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">è¨»ï¼šé»‘æ£‹ä¸‹ç¬¬ä¸€æ‰‹å¾Œæ‰é–‹å§‹è¨ˆæ™‚ã€‚</p>
                        </div>

                        <!-- æç¤ºè¨­å®š (ç°¡åŒ–) -->
                        <div class="mb-5">
                            <label class="block text-gray-700 font-bold mb-2 text-sm">ğŸ›¡ï¸ é˜²å®ˆæç¤º</label>
                            <div class="bg-blue-50 p-3 rounded border border-blue-200 space-y-3">
                                <div class="text-sm text-gray-600 mb-2">
                                    ç•¶å°æ‰‹å½¢æˆè‡´å‘½å¨è„…æ™‚ï¼Œåœ¨ä¸Šæ–¹é¡¯ç¤ºæ–‡å­—è­¦å‘Šï¼š
                                </div>
                                
                                <!-- åƒ…ä¿ç•™ æ´»å››/è¡å›› è¨­å®š -->
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-bold text-red-600">æç¤ºï¼šå°æ‰‹å·²ç¶“å››é¡†äº†</span>
                                    <label class="relative inline-flex items-center cursor-pointer shrink-0">
                                        <input type="checkbox" id="hint-toggle-four" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³å´ï¼šç©æ³•èªªæ˜ -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2"><i class="fas fa-info-circle"></i> ç©æ³•èˆ‡æ“ä½œ</h3>
                        <ul class="space-y-3 text-sm text-gray-700">
                            <li class="flex items-start gap-2">
                                <i class="fas fa-mouse-pointer mt-1 text-blue-500"></i>
                                <span><strong>æ“ä½œæ–¹å¼ï¼š</strong>é»æ“Šæ£‹ç›¤äº¤å‰é»è½å­ã€‚é»‘æ£‹å…ˆè¡Œï¼Œé›™æ–¹è¼ªæµä¸‹å­ã€‚</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i class="fas fa-trophy mt-1 text-yellow-500"></i>
                                <span><strong>ç²å‹æ¢ä»¶ï¼š</strong>å…ˆåœ¨æ©«ã€ç›´ã€æ–œä»»ä¸€æ–¹å‘é€£æˆ <strong>5é¡†</strong> åŒè‰²æ£‹å­è€…ç²å‹ã€‚</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i class="fas fa-shield-alt mt-1 text-red-500"></i>
                                <span><strong>é—œéµæç¤ºï¼š</strong>å¯é¸æ“‡æ˜¯å¦é–‹å•Ÿã€Œå°æ‰‹å·²ç¶“å››é¡†äº†ã€çš„å±éšªè­¦å‘Šã€‚</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i class="fas fa-hourglass-start mt-1 text-green-500"></i>
                                <span><strong>è¨ˆæ™‚é–‹å§‹ï¼š</strong>é»‘æ£‹è½ä¸‹ç¬¬ä¸€å­å¾Œï¼Œè¨ˆæ™‚å™¨æ‰é–‹å§‹å€’æ•¸ã€‚è¶…æ™‚åˆ¤è² ã€‚</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50">
                <button onclick="startGame()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transform transition hover:scale-[1.02] text-lg">
                    é–‹å§‹å°æˆ°
                </button>
            </div>
        </div>
    </div>

    <!-- è¦å‰‡èªªæ˜æµ®çª— -->
    <div id="rules-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal hidden-modal">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 max-w-lg p-6 relative">
            <button onclick="closeRules()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">è¦å‰‡èˆ‡èªªæ˜</h2>
            
            <div class="space-y-4 text-gray-700 text-sm leading-relaxed">
                <p><strong>åŸºæœ¬è¦å‰‡ï¼š</strong>é»‘å…ˆç™½å¾Œï¼Œäº”å­é€£ç·šå³å‹ã€‚</p>
                <p><strong>é˜²å®ˆæç¤ºèªªæ˜ (è‹¥é–‹å•Ÿ)ï¼š</strong></p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>åªæœ‰ç•¶å°æ‰‹ä¸‹å®Œæ£‹å¾Œï¼Œç›¤é¢å‡ºç¾è‡´å‘½å¨è„…æ™‚ï¼Œæ‰æœƒåœ¨ä¸Šæ–¹é¡¯ç¤ºè­¦å‘Šã€‚</li>
                    <li><span class="text-red-500 font-bold">ç´…è‰²è­¦å‘Š</span>ï¼šå°æ‰‹å·²ç¶“å››é¡†äº†ï¼Œå¿…é ˆç«‹å³é˜²å®ˆï¼Œå¦å‰‡è¼¸æ£‹ã€‚</li>
                </ul>
            </div>
            <button onclick="closeRules()" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded">
                å›åˆ°éŠæˆ²
            </button>
        </div>
    </div>

    <!-- éŠæˆ²çµæŸ/è¨Šæ¯æµ®çª— -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 modal hidden-modal">
        <div class="bg-white rounded-lg shadow-2xl w-80 p-6 text-center transform scale-105">
            <div id="message-icon" class="text-6xl mb-4">ğŸ†</div>
            <h2 id="message-title" class="text-2xl font-bold mb-2 text-gray-800">éŠæˆ²çµæŸ</h2>
            <p id="message-body" class="text-gray-600 mb-6">é»‘æ–¹ç²å‹ï¼</p>
            <div class="flex gap-2 justify-center w-full">
                <!-- ä¿®æ”¹æŒ‰éˆ•è¡Œç‚ºï¼šéƒ½å›åˆ°è¨­å®šé  -->
                <button onclick="resetToSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded font-bold w-full shadow-md">
                    å›åˆ°è¨­å®šé¸å–®é‡æ–°é–‹å§‹
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- éŠæˆ²å¸¸æ•¸èˆ‡ç‹€æ…‹ ---
        const BOARD_SIZE = 15;
        const EMPTY = 0;
        const BLACK = 1;
        const WHITE = 2;
        
        let canvas, ctx;
        let cellWidth, boardPadding;
        let board = [];
        let currentPlayer = BLACK;
        let gameActive = false;
        let hasStarted = false; // æ¨™è¨˜éŠæˆ²æ˜¯å¦å·²æ­£å¼é–‹å§‹(ä¸‹äº†ç¬¬ä¸€å­)
        let lastMove = null;
        let showHintsFour = false;  // æ´»å››/è¡å››æç¤º
        
        // è¨ˆæ™‚å™¨ç›¸é—œ
        let timerMode = 'none'; 
        let timerSetting = 0;   
        let timers = { [BLACK]: 0, [WHITE]: 0 };
        let timerInterval = null;
        let lastTimeCheck = 0;

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            window.addEventListener('resize', resizeBoard);
            
            canvas.addEventListener('mousedown', handleInput);
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleInput(e.touches[0]);
            }, {passive: false});

            document.getElementById('timer-mode').addEventListener('change', updateTimerOptions);
            
            updateTimerOptions(); 
            resizeBoard();
            // åˆå§‹é¡¯ç¤ºè¨­å®šè¦–çª—
            document.getElementById('settings-modal').classList.remove('hidden-modal');
        };

        function resizeBoard() {
            const container = canvas.parentElement;
            const size = Math.min(container.clientWidth, container.clientHeight); 
            canvas.width = size;
            canvas.height = size;
            boardPadding = size * 0.05; 
            cellWidth = (size - 2 * boardPadding) / (BOARD_SIZE - 1);
            if (gameActive || board.length > 0 || lastMove) {
                drawBoard();
            }
        }

        // --- UI æ§åˆ¶é‚è¼¯ ---
        function updateTimerOptions() {
            const mode = document.getElementById('timer-mode').value;
            const optionsDiv = document.getElementById('timer-options');
            const select = document.getElementById('timer-seconds');
            select.innerHTML = '';
            if (mode === 'none') {
                optionsDiv.classList.add('hidden');
            } else if (mode === 'step') {
                optionsDiv.classList.remove('hidden');
                [5, 10, 15, 20, 30].forEach(sec => {
                    const opt = document.createElement('option');
                    opt.value = sec; opt.text = `æ¯æ‰‹ ${sec} ç§’`; select.appendChild(opt);
                });
            } else if (mode === 'bank') {
                optionsDiv.classList.remove('hidden');
                [3, 5, 7].forEach(min => {
                    const opt = document.createElement('option');
                    opt.value = min * 60; opt.text = `ç¸½æ™‚ ${min} åˆ†é˜`; select.appendChild(opt);
                });
            }
        }

        function startGame() {
            timerMode = document.getElementById('timer-mode').value;
            timerSetting = parseInt(document.getElementById('timer-seconds').value);
            
            // è®€å–åˆ†é–‹çš„æç¤ºè¨­å®š (åªå‰©å››é¡†çš„æç¤º)
            showHintsFour = document.getElementById('hint-toggle-four').checked;
            
            currentPlayer = BLACK;
            gameActive = true;
            hasStarted = false; // é‡ç½®é–‹å§‹æ¨™è¨˜
            lastMove = null;
            board = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(EMPTY));
            
            initTimers(); // åˆå§‹åŒ–æ™‚é–“é¡¯ç¤ºï¼Œä½†ä¸é–‹å§‹è¨ˆæ™‚
            
            document.getElementById('settings-modal').classList.add('hidden-modal');
            document.getElementById('message-modal').classList.add('hidden-modal');
            updateHintNotification(); // æ¸…é™¤èˆŠæç¤º
            updateUI(); 
            resizeBoard(); 
            drawBoard();
        }

        // æ–°å¢ï¼šå›åˆ°è¨­å®šé¸å–®çš„å‡½æ•¸
        function resetToSettings() {
            stopTimer();
            gameActive = false;
            hasStarted = false;
            document.getElementById('message-modal').classList.add('hidden-modal');
            // æ¸…ç©ºæ£‹ç›¤è¦–è¦º
            board = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(EMPTY));
            lastMove = null;
            drawBoard();
            updateTimerUI(BLACK, '--');
            updateTimerUI(WHITE, '--');
            updateHintNotification(); // æ¸…è—æç¤º
            // é¡¯ç¤ºè¨­å®šè¦–çª—
            document.getElementById('settings-modal').classList.remove('hidden-modal');
        }
        
        function resetGamePrompt() {
            if(confirm("ç¢ºå®šè¦çµæŸç•¶å‰å°å±€ä¸¦å›åˆ°è¨­å®šé¸å–®å—ï¼Ÿ")) {
                resetToSettings();
            }
        }

        function openRules() {
            document.getElementById('rules-modal').classList.remove('hidden-modal');
        }
        function closeRules() {
            document.getElementById('rules-modal').classList.add('hidden-modal');
        }

        // æ–°å¢ï¼šæ›´æ–°æç¤ºæ©«å¹…æ–‡å­—
        function updateHintNotification() {
            const hintBox = document.getElementById('hint-notification');
            
            // å¦‚æœæ²’é–‹å•Ÿæç¤ºï¼Œç›´æ¥éš±è—
            if (!gameActive || !showHintsFour) {
                hintBox.classList.add('hidden');
                return;
            }

            const threats = analyzeBoardForThreats();
            let maxType = 0;
            for(const t of threats) {
                if (t.type > maxType) maxType = t.type;
            }

            hintBox.className = "w-full p-2 text-center text-sm font-bold z-20 relative shrink-0 transition-all duration-300 border-l-4 shadow-sm";

            // é‚è¼¯åˆ¤æ–·ï¼šType 2: è‡´å‘½å¨è„… (å·²ç”±æ¼”ç®—æ³•ç¢ºä¿æ˜¯å°æ‰‹æœ‰4é¡†)
            if (maxType === 2 && showHintsFour) {
                hintBox.innerText = `âš ï¸ è­¦å‘Šï¼šå°æ–¹å·²ç¶“å››é¡†äº†`;
                hintBox.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                hintBox.classList.remove('hidden');
            } else {
                hintBox.classList.add('hidden');
            }
        }


        // --- éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---

        function handleInput(e) {
            if (!gameActive) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const col = Math.round((x - boardPadding) / cellWidth);
            const row = Math.round((y - boardPadding) / cellWidth);

            if (col >= 0 && col < BOARD_SIZE && row >= 0 && row < BOARD_SIZE) {
                const centerX = boardPadding + col * cellWidth;
                const centerY = boardPadding + row * cellWidth;
                const dist = Math.sqrt((x - centerX)**2 + (y - centerY)**2);
                
                if (dist < cellWidth * 0.45 && board[row][col] === EMPTY) {
                    makeMove(row, col);
                }
            }
        }

        function makeMove(row, col) {
            // æª¢æŸ¥æ˜¯å¦ç‚ºç¬¬ä¸€æ‰‹ï¼Œæ˜¯å‰‡é–‹å§‹è¨ˆæ™‚
            if (!hasStarted) {
                hasStarted = true;
                startTimer();
            }

            board[row][col] = currentPlayer;
            lastMove = { row, col };
            
            drawBoard(); // ç¹ªè£½æ£‹å­å’Œæœ€å¾Œä¸€æ‰‹æ¨™è¨˜
            
            if (checkWin(row, col, currentPlayer)) {
                endGame(currentPlayer, 'win');
                return;
            }
            if (checkDraw()) {
                endGame(null, 'draw');
                return;
            }

            // æ›æ‰‹
            currentPlayer = currentPlayer === BLACK ? WHITE : BLACK;
            
            if (timerMode === 'step') {
                timers[BLACK] = timerSetting * 1000;
                timers[WHITE] = timerSetting * 1000;
            }
            
            updateUI(); // åˆ‡æ›é¢æ¿
            updateHintNotification(); // æ›´æ–°æ–‡å­—æç¤º
            // drawBoard(); // ä¸éœ€è¦å†é‡ç¹ªä¸€æ¬¡ï¼ŒupdateUIå’ŒupdateHintNotificationä¸å½±éŸ¿æ£‹ç›¤
        }

        function checkWin(row, col, player) {
            const directions = [[1, 0], [0, 1], [1, 1], [1, -1]];
            for (let [dx, dy] of directions) {
                let count = 1;
                for (let i = 1; i < 5; i++) {
                    const r = row + i * dy;
                    const c = col + i * dx;
                    if (r < 0 || r >= BOARD_SIZE || c < 0 || c >= BOARD_SIZE || board[r][c] !== player) break;
                    count++;
                }
                for (let i = 1; i < 5; i++) {
                    const r = row - i * dy;
                    const c = col - i * dx;
                    if (r < 0 || r >= BOARD_SIZE || c < 0 || c >= BOARD_SIZE || board[r][c] !== player) break;
                    count++;
                }
                if (count >= 5) return true;
            }
            return false;
        }

        function checkDraw() {
            return board.every(row => row.every(cell => cell !== EMPTY));
        }

        // --- é˜²å®ˆæç¤ºæ¼”ç®—æ³• (åˆ†æå¨è„…) ---
        // åˆ†æç•¶å‰å±€é¢ï¼Œæ‰¾å‡º"å°æ‰‹"ï¼ˆå‰›ä¸‹å®Œæ£‹çš„é‚£æ–¹ï¼‰è£½é€ çš„å¨è„…é»
        function analyzeBoardForThreats() {
            const threats = [];
            // æˆ‘å€‘è¦æª¢æŸ¥çš„æ˜¯"å°æ‰‹"çš„æ£‹å‹ã€‚å¦‚æœç¾åœ¨è¼ªåˆ°é»‘æ£‹ï¼Œè¡¨ç¤ºç™½æ£‹å‰›ä¸‹å®Œï¼Œæˆ‘å€‘è¦æª¢æŸ¥ç™½æ£‹çš„å¨è„…ã€‚
            const opponent = currentPlayer === BLACK ? WHITE : BLACK;
            
            for(let r=0; r<BOARD_SIZE; r++){
                for(let c=0; c<BOARD_SIZE; c++){
                    if(board[r][c] === EMPTY) {
                        // å‡è¨­å°æ‰‹ä¸‹åœ¨é€™å€‹ç©ºä½ï¼Œè©•ä¼°å…¶å¼·åº¦
                        const type = evaluateMoveStrength(r, c, opponent);
                        if (type > 0) {
                            threats.push({r, c, type}); 
                        }
                    }
                }
            }
            return threats;
        }

        function evaluateMoveStrength(row, col, player) {
            board[row][col] = player; // æš«æ™‚è½ä¸‹ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹
            let isWin = false; 
            // æ³¨æ„ï¼šæˆ‘å€‘ç§»é™¤ isFour çš„è®Šæ•¸ï¼Œå› ç‚ºæˆ‘å€‘åªåœ¨ä¹ "æ˜¯å¦å·²ç¶“4é¡†"
            // è€Œ "å·²ç¶“4é¡†" çš„å®šç¾©æ˜¯ï¼šå†ä¸‹ä¸€å­ï¼Œå°±æœƒè®Šæˆ5é¡† (count >= 5)
            
            const directions = [[1,0], [0,1], [1,1], [1,-1]];
            
            for (let [dx, dy] of directions) {
                let count = 1; 
                let i = 1;
                while (true) {
                    const r = row + i * dy; const c = col + i * dx;
                    if (r < 0 || r >= BOARD_SIZE || c < 0 || c >= BOARD_SIZE) break;
                    if (board[r][c] === player) count++;
                    else if (board[r][c] === EMPTY) { break; } else break; 
                    i++;
                }
                i = 1;
                while (true) {
                    const r = row - i * dy; const c = col - i * dx;
                    if (r < 0 || r >= BOARD_SIZE || c < 0 || c >= BOARD_SIZE) break;
                    if (board[r][c] === player) count++;
                    else if (board[r][c] === EMPTY) { break; } else break; 
                    i++;
                }
                if (count >= 5) isWin = true;
            }
            board[row][col] = EMPTY; // å¾©åŸ

            // ä¿®æ­£é»ï¼šåªæœ‰ç•¶æ¨¡æ“¬è½å­å¾Œèƒ½é€£æˆ5é¡†ï¼ˆä»£è¡¨ç›¤é¢ä¸Šå·²ç¶“æœ‰4é¡†ï¼Œæˆ–å½¢æˆäº†é›™4ç­‰å¿…å‹å±€ï¼‰ï¼Œæ‰å›å‚³2
            // å¦‚æœæ¨¡æ“¬å¾Œåªæœ‰4é¡†ï¼ˆä»£è¡¨ç›¤é¢ä¸Šåªæœ‰3é¡†ï¼‰ï¼Œå‰‡å›å‚³0 (ä¸æç¤º)
            if (isWin) return 2; 
            return 0;
        }

        // --- ç¹ªåœ–é‚è¼¯ (å·²ç§»é™¤ç¹ªè£½æç¤ºé») ---
        function drawBoard() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ç•«ç·š
            ctx.beginPath();
            ctx.strokeStyle = "#5d4037";
            ctx.lineWidth = canvas.width < 400 ? 1 : 1.5;
            for (let i = 0; i < BOARD_SIZE; i++) {
                ctx.moveTo(boardPadding, boardPadding + i * cellWidth);
                ctx.lineTo(canvas.width - boardPadding, boardPadding + i * cellWidth);
                ctx.moveTo(boardPadding + i * cellWidth, boardPadding);
                ctx.lineTo(boardPadding + i * cellWidth, canvas.height - boardPadding);
            }
            ctx.stroke();
            // ç•«æ˜Ÿä½
            const stars = [3, 11, 7];
            ctx.fillStyle = "#5d4037";
            for(let r of stars) {
                for(let c of stars) {
                    if ((r === 7 && c !== 7) || (c === 7 && r !== 7)) continue;
                    ctx.beginPath();
                    ctx.arc(boardPadding + c * cellWidth, boardPadding + r * cellWidth, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            // ç•«æ£‹å­
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (board[r][c] !== EMPTY) {
                        drawPiece(r, c, board[r][c]);
                    }
                }
            }
            // æ¨™è¨˜æœ€å¾Œä¸€æ‰‹
            if (lastMove) {
                const cx = boardPadding + lastMove.col * cellWidth;
                const cy = boardPadding + lastMove.row * cellWidth;
                ctx.beginPath();
                ctx.strokeStyle = "#ef4444"; // red-500
                ctx.lineWidth = 3;
                ctx.arc(cx, cy, cellWidth * 0.22, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        function drawPiece(row, col, type) {
            const cx = boardPadding + col * cellWidth;
            const cy = boardPadding + row * cellWidth;
            const radius = cellWidth * 0.45;
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            const gradient = ctx.createRadialGradient(cx - radius/3, cy - radius/3, radius/10, cx, cy, radius);
            if (type === BLACK) {
                gradient.addColorStop(0, "#666"); gradient.addColorStop(1, "#000");
            } else {
                gradient.addColorStop(0, "#fff"); gradient.addColorStop(1, "#d1d5db");
            }
            ctx.fillStyle = gradient;
            ctx.fill();
            ctx.shadowColor = "rgba(0,0,0,0.3)";
            ctx.shadowBlur = 3; ctx.shadowOffsetX = 1; ctx.shadowOffsetY = 1;
            ctx.shadowColor = "transparent";
        }

        // --- è¨ˆæ™‚å™¨é‚è¼¯ ---
        function initTimers() {
            if (timerMode === 'none') {
                updateTimerUI(BLACK, '--'); updateTimerUI(WHITE, '--'); return;
            }
            const initialTime = timerSetting * 1000;
            timers[BLACK] = initialTime; timers[WHITE] = initialTime;
            updateTimerDisplay();
        }

        function startTimer() {
            stopTimer();
            if (timerMode === 'none') return;
            lastTimeCheck = Date.now();
            timerInterval = setInterval(() => {
                if (!gameActive) { stopTimer(); return; }
                const now = Date.now();
                const delta = now - lastTimeCheck;
                lastTimeCheck = now;
                timers[currentPlayer] -= delta;
                updateTimerDisplay();
                if (timers[currentPlayer] <= 0) {
                    timers[currentPlayer] = 0;
                    updateTimerDisplay();
                    stopTimer();
                    endGame(currentPlayer === BLACK ? WHITE : BLACK, 'timeout');
                }
            }, 100);
        }

        function stopTimer() {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        }

        function updateTimerDisplay() {
            const formatTime = (ms) => {
                const totalSec = Math.ceil(ms / 1000);
                if (timerMode === 'step') return `${totalSec}s`;
                const m = Math.floor(totalSec / 60); const s = totalSec % 60;
                return `${m}:${s.toString().padStart(2, '0')}`;
            };
            updateTimerUI(BLACK, formatTime(timers[BLACK]), timers[BLACK]);
            updateTimerUI(WHITE, formatTime(timers[WHITE]), timers[WHITE]);
        }

        function updateTimerUI(player, text, ms = 99999) {
            const el = document.getElementById(player === BLACK ? 'timer-black' : 'timer-white');
            el.innerText = text;
            if (timerMode !== 'none' && ms < 5000 && hasStarted) {
                el.classList.add('text-red-600', 'animate-pulse'); el.classList.remove('text-gray-600');
            } else {
                el.classList.add('text-gray-600'); el.classList.remove('text-red-600', 'animate-pulse');
            }
        }

        function updateUI() {
            const pBlack = document.getElementById('panel-black');
            const pWhite = document.getElementById('panel-white');
            pBlack.classList.remove('active'); pWhite.classList.remove('active');
            pBlack.querySelector('.turn-badge').style.opacity = '0';
            pWhite.querySelector('.turn-badge').style.opacity = '0';
            if (currentPlayer === BLACK) {
                pBlack.classList.add('active'); pBlack.querySelector('.turn-badge').style.opacity = '1';
            } else {
                pWhite.classList.add('active'); pWhite.querySelector('.turn-badge').style.opacity = '1';
            }
        }

        function endGame(winner, reason) {
            gameActive = false;
            stopTimer();
            updateHintNotification(); // æ¸…é™¤æç¤ºæ©«å¹…
            const modal = document.getElementById('message-modal');
            const title = document.getElementById('message-title');
            const body = document.getElementById('message-body');
            const icon = document.getElementById('message-icon');
            modal.classList.remove('hidden-modal');
            if (reason === 'draw') {
                icon.innerText = "ğŸ¤"; title.innerText = "å’Œå±€"; body.innerText = "æ£‹ç›¤å·²æ»¿ï¼Œä¸åˆ†å‹è² ï¼";
            } else {
                const winnerName = winner === BLACK ? "é»‘æ–¹" : "ç™½æ–¹";
                icon.innerText = "ğŸ†"; title.innerText = `${winnerName}ç²å‹ï¼`;
                body.innerText = reason === 'timeout' ? `å°æ‰‹æ™‚é–“è€—ç›¡ï¼Œ${winnerName}è‡ªå‹•ç²å‹ï¼` : `${winnerName}å®Œæˆäº”å­é€£ç·šï¼`;
            }
        }
    </script>
</body>
</html>